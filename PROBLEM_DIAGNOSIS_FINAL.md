# ğŸ” CLI V3.0 ç”Ÿäº§æ•ˆæœå·® - å®Œæ•´è¯Šæ–­æŠ¥å‘Š

## é—®é¢˜æ€»ç»“

æ‰§è¡Œ CLI V3 åï¼Œ**è¾“å‡ºæ–‡ä»¶å‡ ä¹ä¸ºç©º**ï¼Œç”¨æˆ·ä½“éªŒå¾ˆå·®ã€‚

---

## ğŸ” æ·±åº¦è¯Šæ–­

### é—®é¢˜ç°è±¡

```
ğŸ” è°ƒè¯•: æ”¶åˆ° 0 æ¡æ¶ˆæ¯
ğŸ” è°ƒè¯•: å†…å®¹é•¿åº¦ 0 å­—ç¬¦
âš ï¸  è­¦å‘Š: æ­¥éª¤è¾“å‡ºä¸ºç©ºï¼
```

**æ ¹æœ¬é—®é¢˜**: `query()` å‡½æ•°è¿”å›äº† **AsyncIterable**ï¼Œä½†æ²¡æœ‰äº§ç”Ÿä»»ä½•æ¶ˆæ¯ã€‚

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### åŸå›  1: Claude SDK `query()` å‡½æ•°çš„ä½¿ç”¨é—®é¢˜ âŒ

**å½“å‰ä»£ç **:
```javascript
const response = await query({
  prompt,
  options: {
    model: this.config.model,
    maxTurns: this.config.maxTurns,
    settingSources: ['user', 'project'],
    allowedTools: ['WebSearch', 'WebFetch', 'Read', 'Write', 'Bash', 'Edit'],
  }
});

// æ”¶é›†å“åº”
let content = '';
for await (const message of response) {
  if (message.type === 'text') {
    content += message.text;
  }
}
```

**é—®é¢˜**:
- `query()` è¿”å›çš„ AsyncIterable **æ²¡æœ‰äº§ç”Ÿä»»ä½•æ¶ˆæ¯**
- è¿™é€šå¸¸å‘ç”Ÿåœ¨ä»¥ä¸‹æƒ…å†µ:
  1. Prompt ä¸å¤Ÿæ¸…æ™°ï¼ŒClaude ä¸çŸ¥é“å¦‚ä½•å“åº”
  2. æ²¡æœ‰æ˜ç¡®çš„ä»»åŠ¡æŒ‡ä»¤
  3. æ²¡æœ‰æä¾›è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡

### åŸå›  2: Prompt è®¾è®¡ä¸å½“ âš ï¸

**å½“å‰çš„ Prompt**:
```javascript
const prompt = `## ä»»åŠ¡: ${workflowStep.title}

### ä»»åŠ¡æè¿°
${workflowStep.task}

### æœŸæœ›è¾“å‡º
${workflowStep.expectedOutput}

### éªŒè¯æ ‡å‡†
${workflowStep.validation}

è¯·ç›´æ¥å®Œæˆä¸Šè¿°ä»»åŠ¡...`;
```

**é—®é¢˜**:
- `workflowStep.task` å¯èƒ½è¿‡äºæŠ½è±¡
- æ²¡æœ‰å…·ä½“çš„ç”¨æˆ·è¯·æ±‚
- Claude ä¸çŸ¥é“è¦åšä»€ä¹ˆ

**å®é™…æƒ…å†µ**:
```javascript
// workflowStep.task = "ç¼–æ’æ‰§è¡Œ"
// è¿™ä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡ï¼
```

### åŸå›  3: å·¥ä½œæµè®¾è®¡ä¸å®é™…æ‰§è¡Œä¸åŒ¹é… âŒ

**è®¾è®¡çš„å·¥ä½œæµ**:
```javascript
getJournalSubmissionWorkflow() {
  return {
    name: 'æœŸåˆŠæŠ•ç¨¿å·¥ä½œæµ',
    steps: [
      {
        id: 'match',
        title: 'æœŸåˆŠåŒ¹é…',
        task: 'åŒ¹é…åˆé€‚çš„å­¦æœ¯æœŸåˆŠ',  // âŒ å¤ªæŠ½è±¡
        skillIds: ['journal-matchmaker', 'journal-submission'],
      }
    ]
  };
}
```

**é—®é¢˜**:
- å·¥ä½œæµçš„ `task` å­—æ®µä¸æ˜¯ç”¨æˆ·çš„å…·ä½“è¯·æ±‚
- Claude æ”¶åˆ°çš„æ˜¯"æœŸåˆŠåŒ¹é…"ï¼Œè€Œä¸æ˜¯"æ¨èé€‚åˆ[å…·ä½“è®ºæ–‡]çš„æœŸåˆŠ"
- ç¼ºå°‘å…·ä½“çš„è¾“å…¥ä¿¡æ¯ï¼ˆè®ºæ–‡æ ‡é¢˜ã€æ‘˜è¦ã€é¢†åŸŸç­‰ï¼‰

---

## ğŸ’¡ ä¸ºä»€ä¹ˆæµ‹è¯•é€šè¿‡ä½†ç”Ÿäº§å¤±è´¥ï¼Ÿ

### å•å…ƒæµ‹è¯• vs çœŸå®æ‰§è¡Œ

**å•å…ƒæµ‹è¯•** (cli-v3-skills-integration.test.mjs):
```javascript
it('åº”è¯¥åŒ…å« executeStep æ–¹æ³•', async () => {
  const content = await fs.readFile(CLI_PATH, 'utf-8');
  expect(content).toContain('async executeStep(');
});
```

**æµ‹è¯•çš„æ˜¯ä»€ä¹ˆ**:
- âœ… ä»£ç å­˜åœ¨
- âœ… æ–¹æ³•å®šä¹‰æ­£ç¡®
- âœ… è¯­æ³•æ­£ç¡®

**æµ‹è¯•æ²¡æµ‹è¯•ä»€ä¹ˆ**:
- âŒ `query()` æ˜¯å¦è¿”å›æ¶ˆæ¯
- âŒ Prompt æ˜¯å¦æœ‰æ•ˆ
- âŒ è¾“å‡ºæ˜¯å¦è¢«æ­£ç¡®æ•è·
- âŒ å®é™…æ‰§è¡Œæ—¶çš„è¡Œä¸º

### çœŸå®æ‰§è¡Œ

**çœŸå®æ‰§è¡Œæ—¶**:
1. CLI å¯åŠ¨ âœ…
2. Skills å‘ç° âœ…
3. ä»»åŠ¡åˆ†æ âœ…
4. å·¥ä½œæµç”Ÿæˆ âœ…
5. **æ‰§è¡Œæ­¥éª¤** âŒ `query()` è¿”å›ç©º
6. è¾“å‡ºä¿å­˜ âŒ å†…å®¹ä¸ºç©º

---

## ğŸš¨ å…³é”®å‘ç°

### å‘ç° 1: workflow-manager çš„é—®é¢˜

**workflow-manager Skill çš„ä½œç”¨**:
- ç¼–æ’å¤šä¸ª Skills
- åè°ƒæ‰§è¡Œ
- ç»¼åˆç»“æœ

**ä½†åœ¨ CLI ä¸­çš„ä½¿ç”¨**:
```javascript
// CLI å°è¯•è°ƒç”¨ workflow-manager
// ä½† workflow-manager åˆè¦è°ƒç”¨å…¶ä»– Skills
// å½¢æˆ: CLI â†’ query() â†’ workflow-manager (Skill) â†’ journal-submission (Skill)
```

**é—®é¢˜**:
- å¤šå±‚åµŒå¥—å¯¼è‡´ä¸Šä¸‹æ–‡ä¸¢å¤±
- Fork Context éš”ç¦»å¯¼è‡´è¾“å‡ºæ— æ³•è¿”å›
- å¤æ‚çš„ç¼–æ’é€»è¾‘ç®€åŒ–ä¸ºå•ä¸€çš„ query() è°ƒç”¨

### å‘ç° 2: Skills çš„å®é™…ä½¿ç”¨æ–¹å¼

**æ­£ç¡®çš„æ–¹å¼** (åœ¨ SKILL.md ä¸­):
```markdown
## ä½¿ç”¨è¿™ä¸ª Skill å½“...

ç”¨æˆ·è¯·æ±‚åŒ…å«ä»¥ä¸‹å…³é”®è¯æ—¶:
- "æ¨èæœŸåˆŠ"
- "æœŸåˆŠæŠ•ç¨¿"
- "é€‚åˆå‘è¡¨"

## å¦‚ä½•ä½¿ç”¨

ç›´æ¥è°ƒç”¨è¿™ä¸ª Skillï¼Œå®ƒä¼š:
1. åˆ†æè®ºæ–‡ä¸»é¢˜
2. æœç´¢åˆé€‚çš„æœŸåˆŠ
3. æä¾›æ¨èåˆ—è¡¨
```

**CLI ä¸­çš„é”™è¯¯ä½¿ç”¨**:
```javascript
// CLI æœŸæœ› workflow-manager è°ƒç”¨ journal-submission
// ä½†å®é™…ä¸Š query() ç›´æ¥è¢«è°ƒç”¨ï¼Œæ²¡æœ‰è§¦å‘ä»»ä½• Skill
```

### å‘ç° 3: Claude SDK çš„é™åˆ¶

**Claude SDK çš„ `query()` å‡½æ•°**:
- éœ€è¦**æ¸…æ™°çš„ä»»åŠ¡æè¿°**
- éœ€è¦**å…·ä½“çš„ç”¨æˆ·è¯·æ±‚**
- éœ€è¦**æ˜ç¡®çš„è¾“å‡ºæ ¼å¼**

**CLI çš„ Prompt**:
- åªæœ‰æŠ½è±¡çš„ä»»åŠ¡æè¿°ï¼ˆ"æœŸåˆŠåŒ¹é…"ï¼‰
- ç¼ºå°‘å…·ä½“çš„ç”¨æˆ·è¾“å…¥
- Claude ä¸çŸ¥é“è¦åšä»€ä¹ˆ

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä¼ é€’ç”¨æˆ·çš„å…·ä½“è¯·æ±‚ â­â­â­

**ä¿®æ”¹å·¥ä½œæµç”Ÿæˆ**:
```javascript
async generateWorkflow(taskAnalysis, userRequest, availableSkills) {
  const workflow = {
    name: 'æœŸåˆŠæŠ•ç¨¿å·¥ä½œæµ',
    steps: [
      {
        id: 'match',
        title: 'æœŸåˆŠåŒ¹é…',
        task: userRequest,  // âœ… ç›´æ¥ä½¿ç”¨ç”¨æˆ·çš„å…·ä½“è¯·æ±‚
        expectedOutput: 'æœŸåˆŠæ¨èåˆ—è¡¨å’ŒæŠ•ç¨¿è¦æ±‚',
        validation: 'è‡³å°‘æ¨è 5 ä¸ªæœŸåˆŠ',
      }
    ]
  };

  return workflow;
}
```

**ä¿®æ”¹ executeStep**:
```javascript
async executeStep(workflowStep, checklistStep) {
  // workflowStep.task ç°åœ¨æ˜¯ç”¨æˆ·çš„çœŸå®è¯·æ±‚
  const prompt = `## ä»»åŠ¡

${workflowStep.task}

è¯·å®Œæˆä¸Šè¿°ä»»åŠ¡ï¼Œæä¾›è¯¦ç»†çš„è¾“å‡ºã€‚`;

  const response = await query({
    prompt,
    options: { ... }
  });
}
```

### æ–¹æ¡ˆ 2: å®Œå…¨ä¸ä½¿ç”¨ workflow-manager Skill â­â­

**åŸç†**: CLI è‡ªå·±å®ç°ç¼–æ’é€»è¾‘ï¼Œä¸ä¾èµ– workflow-manager

**å®ç°**:
```javascript
// ä¸éœ€è¦ workflow-manager
// ç›´æ¥åœ¨ CLI ä¸­è°ƒç”¨ä¸åŒçš„"å·¥ä½œæµ"

async executeJournalSubmissionWorkflow(userRequest) {
  console.log('ğŸ“‹ æœŸåˆŠåŒ¹é…\n');

  const prompt = `ä½ æ˜¯æœŸåˆŠæ¨èä¸“å®¶ã€‚

## ç”¨æˆ·è¯·æ±‚
${userRequest}

## ä»»åŠ¡
1. æ¨èè‡³å°‘ 5 ä¸ªåˆé€‚çš„æœŸåˆŠ
2. è¯´æ˜æ¯ä¸ªæœŸåˆŠçš„æŠ•ç¨¿è¦æ±‚
3. æä¾›æœŸåˆŠçš„å½±å“å› å­ã€å½•ç”¨ç‡ç­‰ä¿¡æ¯

è¯·å¼€å§‹æ¨è:`;

  const response = await query({
    prompt,
    options: {
      model: this.config.model,
      maxTurns: 10,
      allowedTools: ['WebSearch', 'WebFetch', 'Read'],
    }
  });

  let content = '';
  for await (const message of response) {
    if (message.type === 'text') {
      process.stdout.write(message.text);
      content += message.text;
    }
  }

  return content;
}
```

### æ–¹æ¡ˆ 3: ä½¿ç”¨ V2 çš„ç®€å•æ–¹æ³• â­â­â­â­â­

**V2 çš„æ–¹æ³•** (å·¥ä½œè‰¯å¥½):
```javascript
const response = await query({
  prompt: userRequest,  // âœ… ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¯·æ±‚
  options: {
    model: CONFIG.model,
    maxTurns: CONFIG.maxTurns,
    settingSources: ['user', 'project'],
    allowedTools: ['Skill', 'WebSearch', 'WebFetch', 'Read', 'Write', 'Bash', 'Edit'],
  }
});
```

**ä¸ºä»€ä¹ˆ V2 å·¥ä½œä½† V3 ä¸å·¥ä½œ**:
- V2 ç›´æ¥ä¼ é€’ç”¨æˆ·è¯·æ±‚
- V3 ä½¿ç”¨æŠ½è±¡çš„ä»»åŠ¡æè¿°
- Claude éœ€è¦å…·ä½“çš„è¯·æ±‚æ‰èƒ½ç†è§£

---

## ğŸ“ æ¨èçš„æœ€ç»ˆä¿®å¤

### ä¿®å¤æ­¥éª¤

1. **ç®€åŒ–æ¶æ„**
   - ç§»é™¤å¤æ‚çš„ workflow-manager ä¾èµ–
   - ç›´æ¥åœ¨ CLI ä¸­å®ç°å·¥ä½œæµé€»è¾‘

2. **ä¼ é€’å…·ä½“è¯·æ±‚**
   - ä½¿ç”¨ç”¨æˆ·çš„åŸå§‹è¯·æ±‚ï¼Œè€Œä¸æ˜¯æŠ½è±¡çš„ä»»åŠ¡æè¿°
   - ç¡®ä¿ Claude èƒ½ç†è§£è¦åšä»€ä¹ˆ

3. **æ”¹è¿› Prompt**
   - æä¾›æ¸…æ™°çš„ä»»åŠ¡æè¿°
   - åŒ…å«ç”¨æˆ·çš„å…·ä½“è¾“å…¥
   - æ˜ç¡®æœŸæœ›çš„è¾“å‡ºæ ¼å¼

4. **å‚è€ƒ V2 çš„æˆåŠŸç»éªŒ**
   - V2 è™½ç„¶ç®€å•ï¼Œä½†å·¥ä½œè‰¯å¥½
   - V3 è¿‡åº¦å¤æ‚åŒ–äº†
   - ç®€å•å¾€å¾€æ˜¯æœ€å¥½çš„

### å¿«é€Ÿä¿®å¤ä»£ç 

```javascript
async executeSimpleWorkflow(userRequest) {
  console.log(`\nğŸ“‹ æ‰§è¡Œä»»åŠ¡: ${userRequest}\n`);

  const prompt = `ä½ æ˜¯å­¦æœ¯åŠ©æ‰‹ã€‚

## ç”¨æˆ·è¯·æ±‚
${userRequest}

è¯·å®Œæˆä¸Šè¿°ä»»åŠ¡ï¼Œæä¾›è¯¦ç»†çš„ã€ç»“æ„åŒ–çš„è¾“å‡ºã€‚

ä½ å¯ä»¥ä½¿ç”¨:
- WebSearch: æœç´¢ä¿¡æ¯
- WebFetch: è·å–ç½‘é¡µ
- Read: è¯»å–æ–‡ä»¶
- Write: å†™å…¥æ–‡ä»¶

**é‡è¦**: ç›´æ¥å®Œæˆä»»åŠ¡ï¼Œæä¾›ä¸°å¯Œã€è¯¦ç»†ã€æœ‰ä»·å€¼çš„è¾“å‡ºã€‚`;

  const response = await query({
    prompt,
    options: {
      model: this.config.model,
      maxTurns: 10,
      settingSources: ['user', 'project'],
      allowedTools: ['WebSearch', 'WebFetch', 'Read', 'Write', 'Bash', 'Edit'],
    }
  });

  let content = '';
  let messageCount = 0;

  for await (const message of response) {
    if (message.type === 'text') {
      messageCount++;
      process.stdout.write(message.text);
      content += message.text;
    }
  }

  console.log(`\n\nâœ… å®Œæˆï¼æ”¶åˆ° ${messageCount} æ¡æ¶ˆæ¯ï¼Œ${content.length} å­—ç¬¦`);

  return content;
}
```

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. å¤æ‚æ€§ä¸ç­‰äºé«˜çº§
- V3 å¼•å…¥äº†å¤æ‚çš„ç¼–æ’ç³»ç»Ÿ
- ä½†å®é™…ä¸Šé™ä½äº†æ•ˆæœ
- **ç®€å•å¾€å¾€æ›´å¥½**

### 2. å•å…ƒæµ‹è¯•çš„å±€é™æ€§
- æµ‹è¯•é€šè¿‡ä¸ä»£è¡¨ç”Ÿäº§å¯ç”¨
- éœ€è¦çœŸå®çš„ç«¯åˆ°ç«¯æµ‹è¯•
- éœ€è¦æµ‹è¯•å®é™…çš„è¾“å‡ºè´¨é‡

### 3. ç†è§£å·¥å…·çš„æœ¬è´¨
- Claude SDK çš„ `query()` éœ€è¦æ¸…æ™°çš„è¾“å…¥
- æŠ½è±¡çš„ä»»åŠ¡æè¿°ä¼šå¯¼è‡´å¤±è´¥
- **å…·ä½“çš„ç”¨æˆ·è¯·æ±‚æ˜¯å…³é”®**

### 4. Skills çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼
- Skills åº”è¯¥ç›´æ¥å“åº”ç”¨æˆ·è¯·æ±‚
- ä¸åº”è¯¥æœ‰å¤šå±‚åµŒå¥—
- **æ‰å¹³åŒ–ä¼˜äºå±‚æ¬¡åŒ–**

---

## ğŸš€ ç«‹å³å¯ç”¨çš„è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨ V2 çš„ CLI** (å·²éªŒè¯å·¥ä½œ):
```bash
bun run academic-cli.mjs "æ¨èåˆé€‚çš„è®¡ç®—æœºç§‘å­¦æœŸåˆŠå¹¶è¯´æ˜æŠ•ç¨¿è¦æ±‚"
```

**æˆ–è€…ä½¿ç”¨ç®€åŒ–åçš„ V3**:
```bash
# éœ€è¦å…ˆæŒ‰ç…§ä¸Šè¿°æ–¹æ¡ˆä¿®å¤
bun run academic-cli-v3.mjs "æ¨èåˆé€‚çš„è®¡ç®—æœºç§‘å­¦æœŸåˆŠå¹¶è¯´æ˜æŠ•ç¨¿è¦æ±‚"
```

---

## ğŸ“Š å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | V2 | V3 (è®¾è®¡) | V3 (å®é™…) |
|------|----|-----------|-----------|
| æ¶æ„ | ç®€å• | å¤æ‚ | è¿‡åº¦å¤æ‚ |
| Skills ç¼–æ’ | æ—  | workflow-manager | âŒ å¤±è´¥ |
| è¾“å‡ºè´¨é‡ | âœ… è‰¯å¥½ | âŒ ä¸ºç©º | âŒ ä¸ºç©º |
| ç”¨æˆ·ä½“éªŒ | âœ… è‰¯å¥½ | âŒ å·® | âŒ å·® |
| å¯ç»´æŠ¤æ€§ | âœ… é«˜ | âš ï¸ ä½ | âš ï¸ ä½ |

---

## ğŸ¯ å»ºè®®

1. **å›é€€åˆ° V2 çš„ç®€å•æ¶æ„**
   - V2 å·¥ä½œè‰¯å¥½
   - V3 è¿‡åº¦è®¾è®¡
   - ç®€å•å°±æ˜¯ç¾

2. **å¦‚æœè¦æ”¹è¿› V2**:
   - æ·»åŠ æ›´å¥½çš„è¿›åº¦æ˜¾ç¤º
   - æ”¹è¿›è¾“å‡ºæ ¼å¼
   - æ·»åŠ æ›´å¤šç¤ºä¾‹
   - **ä½†ä¿æŒç®€å•çš„æ¶æ„**

3. **ä¸è¦è¿‡åº¦ä¾èµ– Skills ç¼–æ’**
   - Skills ç¼–æ’å¤æ‚ä¸”ä¸å¯é 
   - ç›´æ¥çš„ prompt æ›´æœ‰æ•ˆ
   - æ‰å¹³åŒ–ä¼˜äºå±‚æ¬¡åŒ–

---

**æœ€ç»ˆå»ºè®®**: ä½¿ç”¨ V2 CLIï¼Œå®ƒå·¥ä½œè‰¯å¥½ä¸”å¯é ã€‚

V3 çš„é—®é¢˜åœ¨äº**è¿‡åº¦å¤æ‚çš„æ¶æ„**å’Œ**æŠ½è±¡çš„ä»»åŠ¡æè¿°**ï¼Œå¯¼è‡´ Claude SDK æ— æ³•æ­£ç¡®ç†è§£å’Œæ‰§è¡Œã€‚
